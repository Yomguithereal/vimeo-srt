/*
 *  Project: Vimeo Srt Plugin
 *  Description: A simplistic jQuery plugin to display srt subtitles with vimeo
 *  embedded videos.
 *  Author: PLIQUE Guillaume (Yomguithereal)
 *  Dependancies : -- Froogaloop API --
 *  License: MIT
 */
(function($,$f,window,document,undefined){var vimeoSrt="vimeoSrt",defaults={srt:"sample.srt"};function Plugin(element,options){this.element=element;this.options=$.extend({},defaults,options);this._defaults=defaults;this._name="vimeoSrt";this._srt=[];this._currentSecond=0;this._$iframe=false;this._$subtitles=false;this._spaces=new RegExp("\n\n|\r\n\r\n|\r\r","g");this._carriages=new RegExp("\n|\r\n|\r","g");this.init()}function toMilliseconds(time){var split=time.split(",");var milliseconds=parseInt(split[1]);
var subsplit=split[0].split(":");var seconds=parseInt(subsplit[0])*60*60+parseInt(subsplit[1])*60+parseInt(subsplit[2]);return parseFloat(seconds+"."+milliseconds)}function convertSeconds(seconds){var milliseconds=seconds.split(".")[1];seconds=parseInt(seconds);return toTime(seconds)+","+milliseconds}function getClosest(array,target){var tuples=array.map(function(val){return[val,Math.abs(val.seconds_begin-target)]});return tuples.reduce(function(memo,val){return memo[1]<val[1]?memo:val},[-1,999])[0]}
Plugin.prototype={init:function(){var self=this;this._$iframe=$(this.element);this._$iframe.load(loadSrt);function loadSrt(){$.get(self.options.srt,function(srt){self._$iframe.after('<div id="'+self.element.getAttribute("id")+'_subtitles">&nbsp;</div>');self._$subtitles=$("#"+self.element.getAttribute("id")+"_subtitles");self.parseSrt(srt);froogaloopEvent()})}function froogaloopEvent(){var player=$f(self.element.getAttribute("id"));player.addEvent("ready",function(){player.addEvent("playProgress",
onPlayProgress)});function onPlayProgress(data,id){self._currentSecond=parseFloat(data.seconds);var step=self.findSuitableStep();if(step)self._$subtitles.html(step.text)}}},parseSrt:function(srt_string){var self=this;srt_string.split(this._spaces).forEach(function(step){var split=step.split(self._carriages);if(split[1]!==undefined)self._srt.push({"seconds_begin":toMilliseconds(split[1].split(" --\x3e ")[0]),"seconds_end":toMilliseconds(split[1].split(" --\x3e ")[1]),"time":split[1],"text":split.slice(2,
5).join("<br>")})})},findSuitableStep:function(){var step=getClosest(this._srt,this._currentSecond);return step.seconds_begin>this._currentSecond?false:step}};$.fn[vimeoSrt]=function(options){return this.each(function(){if(!$.data(this,"plugin_"+vimeoSrt))$.data(this,"plugin_"+vimeoSrt,new Plugin(this,options))})}})(jQuery,Froogaloop,window,document);